# Modification of the module is allowed only if the license is retained.
# MMP""MM""YMM `7MMF' `7MF' `7MM"""Mq. 7MM"""YMM
# P' MM `7 `MA ,V MM `MM. MM 7
# MM VM: ,V MM ,M9 MM d
# MM MM. M' MMmmdM9 MMmmMM
# MM `MM A' MM MM Y ,
# MM :MM; MM MM ,M
# .JMML. VF .JMML. .JMMmmmmMMM
# ,M
# This module is licensed and fully copyrighted by Type, copyright is allowed while maintaining the author's mention in the code.
# meta developer: @TypeModules

import logging
import aiohttp
from .. import loader, utils

logger = logging.getLogger(__name__)

DEFAULT_STRINGS = {
    "name": "PhoneChecker",
    "no_key": "üö´ <b>API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</b>\n–ü–æ–ª—É—á–∏ –µ–≥–æ –Ω–∞ <a href='https://numlookupapi.com/'>numlookupapi.com</a> –∏ —É—Å—Ç–∞–Ω–æ–≤–∏ –∫–æ–º–∞–Ω–¥–æ–π <code>.hlrkey &lt;–∫–ª—é—á&gt;</code>",
    "key_set": "üîë <b>API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</b>",
    "no_phone": "ü§î <b>–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</b>",
    "processing": "üîÑ <b>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...</b>",
    "api_error_detailed": "‚ùóÔ∏è <b>–û—à–∏–±–∫–∞ API:</b> <code>{error}</code>",
    "api_error_generic": "‚ùóÔ∏è <b>–û—à–∏–±–∫–∞ API.</b> –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞, API –∫–ª—é—á –∏–ª–∏ –ª–∏–º–∏—Ç—ã –Ω–∞ —Å–µ—Ä–≤–∏—Å–µ.",
    "phone_info": (
        "üì± <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–º–µ—Ä–µ</b> <code>{number}</code>\n\n"
        "‚úîÔ∏è <b>–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å:</b> {valid}\n"
        "üó∫Ô∏è <b>–°—Ç—Ä–∞–Ω–∞:</b> <code>{country} ({country_code})</code>\n"
        "üìç <b>–†–µ–≥–∏–æ–Ω:</b> <code>{location}</code>\n"
        "üì° <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> <code>{carrier}</code>\n"
        "‚òéÔ∏è <b>–¢–∏–ø –ª–∏–Ω–∏–∏:</b> <code>{line_type}</code>"
    ),
}

PREMIUM_STRINGS = {
    "name": "PhoneChecker",
    "no_key": "<emoji document_id=5258318620722733379>‚ùå</emoji> <b>API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</b>\n–ü–æ–ª—É—á–∏ –µ–≥–æ –Ω–∞ <a href='https://numlookupapi.com/'>numlookupapi.com</a> –∏ —É—Å—Ç–∞–Ω–æ–≤–∏ –∫–æ–º–∞–Ω–¥–æ–π <code>.hlrkey &lt;–∫–ª—é—á&gt;</code>",
    "key_set": "<emoji document_id=5260726538302660868>‚úÖ</emoji> <b>API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</b>",
    "no_phone": "<emoji document_id=5257991477358763590>‚ÜóÔ∏è</emoji> <b>–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</b>",
    "processing": "<emoji document_id=5454074580010295588>üòÄ</emoji> <b>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...</b>",
    "api_error_detailed": "<emoji document_id=5260249440450520061>ü§ö</emoji> <b>–û—à–∏–±–∫–∞ API:</b> <code>{error}</code>",
    "api_error_generic": "<emoji document_id=5260249440450520061>ü§ö</emoji> <b>–û—à–∏–±–∫–∞ API.</b> –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞, API –∫–ª—é—á –∏–ª–∏ –ª–∏–º–∏—Ç—ã –Ω–∞ —Å–µ—Ä–≤–∏—Å–µ.",
    "phone_info": (
        "<emoji document_id=5294096239464295059>üîµ</emoji> <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–º–µ—Ä–µ</b> <code>{number}</code>\n\n"
        "<emoji document_id=5454156248813432363>üé•</emoji> <b>–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å:</b> {valid}\n"
        "<emoji document_id=5397730656400714154>üè≥Ô∏è</emoji> <b>–°—Ç—Ä–∞–Ω–∞:</b> <code>{country} ({country_code})</code>\n"
        "<emoji document_id=5429571366384842791>üîé</emoji> <b>–†–µ–≥–∏–æ–Ω:</b> <code>{location}</code>\n"
        "<emoji document_id=5258503720928288433>‚ÑπÔ∏è</emoji> <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> <code>{carrier}</code>\n"
        "<emoji document_id=5258337316715373336>ü§ô</emoji> <b>–¢–∏–ø –ª–∏–Ω–∏–∏:</b> <code>{line_type}</code>"
    ),
}

@loader.tds
class PhoneCheckerMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–æ–º–µ—Ä–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ HLR-–ø–æ–¥–æ–±–Ω—ã–π –∑–∞–ø—Ä–æ—Å."""

    strings = DEFAULT_STRINGS
    _is_premium = False

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "api_key",
                None,
                "API –∫–ª—é—á –æ—Ç numlookupapi.com",
                validator=loader.validators.Hidden(),
            )
        )

    def _get_string(self, key):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞."""
        if self._is_premium:
            return PREMIUM_STRINGS.get(key, f"STRING {key} NOT FOUND")
        return DEFAULT_STRINGS.get(key, f"STRING {key} NOT FOUND")

    async def client_ready(self, client, db):
        self.client = client
        me = await self.client.get_me()
        if me and me.premium:
            self._is_premium = True

    async def hlrkeycmd(self, message):
        """<–∫–ª—é—á> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á –¥–ª—è numlookupapi."""
        key = utils.get_args_raw(message)
        if not key:
            await utils.answer(message, "ü§î <b>–£–∫–∞–∂–∏ API –∫–ª—é—á.</b>")
            return
        
        self.config["api_key"] = key
        await utils.answer(message, self._get_string("key_set"))

    async def hlrcmd(self, message):
        """<–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞> - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."""
        if not self.config["api_key"]:
            await utils.answer(message, self._get_string("no_key"))
            return

        phone_number = utils.get_args_raw(message)
        if not phone_number:
            await utils.answer(message, self._get_string("no_phone"))
            return

        message = await utils.answer(message, self._get_string("processing"))
        
        cleaned_phone = "".join(filter(str.isdigit, phone_number.replace('+', '')))

        api_url = f"https://api.numlookupapi.com/v1/validate/{cleaned_phone}"
        headers = {"apikey": self.config["api_key"]}

        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(api_url, headers=headers) as response:
                    data = await response.json()
        except Exception as e:
            logger.error(f"PhoneChecker API request failed: {e}")
            await utils.answer(message, self._get_string("api_error_generic"))
            return

        if "valid" not in data:
            error_message = data.get("message", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
            await utils.answer(message, self._get_string("api_error_detailed").format(error=error_message))
            return

        valid_status = "–î–∞" if data.get("valid") else "–ù–µ—Ç"
        country_name = data.get("country_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        country_code = data.get("country_code", "N/A")
        location = data.get("location", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        carrier = data.get("carrier", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        line_type = data.get("line_type", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")

        reply_text = self._get_string("phone_info").format(
            number=utils.escape_html(phone_number),
            valid=valid_status,
            country=country_name,
            country_code=country_code,
            location=location,
            carrier=carrier,
            line_type=line_type.capitalize() if line_type else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
        )

        await utils.answer(message, reply_text)
